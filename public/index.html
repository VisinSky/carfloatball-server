<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CarFloatBall 应用中心管理</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- APK Parser -->
    <script src="https://unpkg.com/app-info-parser/dist/app-info-parser.min.js"></script>

    <style>
      body {
        padding: 0;
        margin: 0;
        background-color: #f5f7fa;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
      .header {
        background: #fff;
        padding: 0 20px;
        height: 60px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .header h1 {
        margin: 0;
        font-size: 20px;
        color: #409eff;
      }
      .main-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .app-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        object-fit: cover;
        background: #eee;
      }
      .upload-demo {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header class="header">
        <h1>CarFloatBall 应用中心管理后台</h1>
        <div v-if="isLoggedIn" style="margin-left: auto">
          <el-button type="info" link @click="handleLogout">退出登录</el-button>
        </div>
      </header>

      <!-- 登录弹窗 (强制) -->
      <el-dialog
        v-model="loginVisible"
        title="管理员登录"
        width="400px"
        :close-on-click-modal="false"
        :close-on-press-escape="false"
        :show-close="false"
      >
        <el-form :model="loginForm" @submit.prevent>
          <el-form-item>
            <el-input
              v-model="loginForm.username"
              placeholder="用户名"
              prefix-icon="User"
            ></el-input>
          </el-form-item>
          <el-form-item>
            <el-input
              v-model="loginForm.password"
              type="password"
              placeholder="密码"
              prefix-icon="Lock"
              show-password
              @keyup.enter="handleLogin"
            ></el-input>
          </el-form-item>
        </el-form>
        <template #footer>
          <el-button type="primary" @click="handleLogin" :loading="loggingIn" style="width: 100%">
            登录
          </el-button>
        </template>
      </el-dialog>

      <div class="main-container" v-if="isLoggedIn">
        <el-card>
          <template #header>
            <div class="card-header">
              <span>应用列表 ({{ tableData.length }})</span>
              <el-button type="primary" @click="handleAdd">
                <el-icon style="margin-right: 4px"><Plus /></el-icon>添加应用
              </el-button>
            </div>
          </template>

          <el-table :data="tableData" style="width: 100%" v-loading="loading">
            <el-table-column label="图标" width="80">
              <template #default="scope">
                <img
                  :src="scope.row.iconUrl || 'https://via.placeholder.com/40'"
                  class="app-icon"
                />
              </template>
            </el-table-column>
            <el-table-column
              prop="name"
              label="名称"
              width="180"
              sortable
            ></el-table-column>
            <el-table-column
              prop="packageName"
              label="包名"
              width="220"
            ></el-table-column>
            <el-table-column label="版本" width="150">
              <template #default="scope">
                <el-tag size="small">{{ scope.row.version }}</el-tag>
                <span style="font-size: 12px; color: #999; margin-left: 5px"
                  >({{ scope.row.versionCode }})</span
                >
              </template>
            </el-table-column>
            <el-table-column label="大小" width="120">
              <template #default="scope">
                {{ formatSize(scope.row.size) }}
              </template>
            </el-table-column>
            <el-table-column prop="category" label="分类" width="100">
              <template #default="scope">
                <el-tag
                  :type="getCategoryType(scope.row.category)"
                  effect="light"
                >
                  {{ getCategoryLabel(scope.row.category) }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="updateTime" label="更新时间" width="180">
              <template #default="scope">
                {{ new Date(scope.row.updateTime).toLocaleString() }}
              </template>
            </el-table-column>
            <el-table-column label="操作" fixed="right" min-width="150">
              <template #default="scope">
                <el-button size="small" @click="handleEdit(scope.row)"
                  >编辑</el-button
                >
                <el-popconfirm
                  title="确定要删除这个应用吗？"
                  @confirm="handleDelete(scope.row)"
                >
                  <template #reference>
                    <el-button size="small" type="danger">删除</el-button>
                  </template>
                </el-popconfirm>
              </template>
            </el-table-column>
          </el-table>
        </el-card>
      </div>

      <!-- 编辑/添加弹窗 -->
      <el-dialog
        v-model="dialogVisible"
        :title="isEdit ? '编辑应用' : '添加应用'"
        width="600px"
      >
        <el-form :model="form" label-width="100px" :rules="rules" ref="formRef">
          <el-form-item label="应用名称" prop="name">
            <el-input
              v-model="form.name"
              placeholder="例如：高德地图车机版"
            ></el-input>
          </el-form-item>

          <el-form-item label="安装包(APK)" prop="downloadUrl">
            <el-upload
              class="upload-demo"
              action="/api/upload"
              :before-upload="handleBeforeUpload"
              :on-success="handleUploadSuccess"
              :on-error="handleUploadError"
              :headers="getAuthHeaders()"
              :show-file-list="false"
              accept=".apk"
            >
              <el-button type="primary" :loading="parsingApk">
                <el-icon style="margin-right: 4px" v-if="!parsingApk"><Upload /></el-icon>
                {{ parsingApk ? '解析中...' : (form.downloadUrl ? '重新上传' : '点击上传APK') }}
              </el-button>
              <span
                style="margin-left: 10px; font-size: 12px; color: #666"
                v-if="form.downloadUrl"
              >
                已上传: {{ form.downloadUrl.split('/').pop() }}
              </span>
            </el-upload>
            <div v-if="apkParseInfo" style="font-size: 12px; color: #67c23a; margin-top: 4px">
              ✓ 已解析: {{ apkParseInfo.packageName }} v{{ apkParseInfo.versionName }}
            </div>
          </el-form-item>

          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="版本号" prop="version">
                <el-input
                  v-model="form.version"
                  placeholder="例如：6.5.0"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="版本代码" prop="versionCode">
                <el-input-number
                  v-model="form.versionCode"
                  :min="1"
                  style="width: 100%"
                ></el-input-number>
              </el-form-item>
            </el-col>
          </el-row>

          <el-form-item label="应用包名" prop="packageName">
            <el-input
              v-model="form.packageName"
              placeholder="例如：com.autonavi.amapauto"
            ></el-input>
          </el-form-item>

          <el-form-item label="应用分类" prop="category">
            <el-select
              v-model="form.category"
              placeholder="请选择"
              style="width: 100%"
            >
              <el-option label="导航" value="nav"></el-option>
              <el-option label="影音" value="media"></el-option>
              <el-option label="工具" value="tools"></el-option>
              <el-option label="其他" value="other"></el-option>
            </el-select>
          </el-form-item>

          <el-form-item label="文件大小(B)" prop="size">
            <el-input
              v-model.number="form.size"
              disabled
              placeholder="上传后自动填充"
            ></el-input>
          </el-form-item>

          <el-form-item label="应用描述">
            <el-input
              type="textarea"
              v-model="form.description"
              rows="3"
            ></el-input>
          </el-form-item>

          <el-form-item label="应用图标">
            <div style="display: flex; align-items: center">
              <el-upload
                class="avatar-uploader"
                action="/api/upload"
                :headers="getAuthHeaders()"
                :show-file-list="false"
                :on-success="handleIconSuccess"
                :on-error="handleIconError"
                accept="image/*"
              >
                <img v-if="form.iconUrl" :src="form.iconUrl" class="app-icon" style="margin-right: 10px; cursor: pointer" />
                <el-icon v-else class="avatar-uploader-icon" style="font-size: 28px; color: #8c939d; width: 40px; height: 40px; line-height: 40px; text-align: center; border: 1px dashed #d9d9d9; border-radius: 6px; cursor: pointer"><Plus /></el-icon>
              </el-upload>
              <el-button v-if="form.iconUrl" size="small" type="danger" link @click="form.iconUrl = ''" style="margin-left: 10px">清除</el-button>
            </div>
            <div style="font-size: 12px; color: #999; line-height: 1.2; margin-top: 4px">支持 jpg/png, 点击框体上传服务器</div>
          </el-form-item>
        </el-form>
        <template #footer>
          <span class="dialog-footer">
            <el-button @click="dialogVisible = false">取消</el-button>
            <el-button type="primary" @click="submitForm" :loading="submitting"
              >确定</el-button
            >
          </span>
        </template>
      </el-dialog>
    </div>

    <script>
      const { createApp, ref, reactive, onMounted } = Vue;
      const { ElMessage } = ElementPlus;

      const app = createApp({
        setup() {
          const loading = ref(false);
          const tableData = ref([]);
          const dialogVisible = ref(false);
          const isEdit = ref(false);
          const submitting = ref(false);
          const formRef = ref(null);
          const parsingApk = ref(false);
          const apkParseInfo = ref(null);

          // Build Auth Logic
          const isLoggedIn = ref(false);
          const loginVisible = ref(true);
          const loggingIn = ref(false);
          const loginForm = reactive({ username: "", password: "" });
          
          const token = localStorage.getItem("adminToken");
          if (token) {
            isLoggedIn.value = true;
            loginVisible.value = false;
          }

          const authHeaders = Vue.computed(() => {
             return { Authorization: `Bearer ${localStorage.getItem("adminToken")}` };
          });
          
          // 用于 el-upload 组件，每次上传时动态获取最新的 token
          const getAuthHeaders = () => {
            return { Authorization: `Bearer ${localStorage.getItem("adminToken")}` };
          };

          const handleLogin = async () => {
            if (!loginForm.username || !loginForm.password) return;
            loggingIn.value = true;
            try {
              const res = await fetch("/api/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(loginForm)
              });
              const data = await res.json();
              if (data.code === 0) {
                localStorage.setItem("adminToken", data.data.token);
                isLoggedIn.value = true;
                loginVisible.value = false;
                ElMessage.success("登录成功");
                fetchApps();
              } else {
                ElMessage.error(data.message);
              }
            } catch (e) {
              ElMessage.error("登录请求失败");
            } finally {
              loggingIn.value = false;
            }
          };

          const handleLogout = () => {
            localStorage.removeItem("adminToken");
            isLoggedIn.value = false;
            loginVisible.value = true;
            loginForm.username = "";
            loginForm.password = "";
          };

          const authenticatedFetch = async (url, options = {}) => {
            const tk = localStorage.getItem("adminToken");
            const headers = { ...options.headers, Authorization: `Bearer ${tk}` };
            const res = await fetch(url, { ...options, headers });
            if (res.status === 401) {
               handleLogout();
               ElMessage.error("登录已过期");
               throw new Error("Unauthorized");
            }
            return res;
          };


          const form = reactive({
            id: "",
            name: "",
            packageName: "",
            version: "",
            versionCode: 1,
            size: 0,
            description: "",
            category: "other",
            iconUrl: "",
            downloadUrl: "",
          });

          const rules = {
            name: [
              { required: true, message: "请输入应用名称", trigger: "blur" },
            ],
            packageName: [
              { required: true, message: "请输入应用包名", trigger: "blur" },
            ],
            version: [
              { required: true, message: "请输入版本号", trigger: "blur" },
            ],
            downloadUrl: [
              { required: true, message: "请上传APK文件", trigger: "change" },
            ],
            category: [
              { required: true, message: "请选择分类", trigger: "change" },
            ],
          };

          const fetchApps = async () => {
            loading.value = true;
            try {
              const res = await fetch("/api/apps");
              const data = await res.json();
              if (data.code === 0) {
                tableData.value = data.data;
              } else {
                ElMessage.error(data.message);
              }
            } catch (e) {
              ElMessage.error("获取列表失败");
            } finally {
              loading.value = false;
            }
          };

          const handleAdd = () => {
            isEdit.value = false;
            Object.keys(form).forEach(
              (key) => (form[key] = key === "versionCode" ? 1 : ""),
            );
            form.category = "other";
            dialogVisible.value = true;
          };

          const handleEdit = (row) => {
            isEdit.value = true;
            Object.assign(form, row);
            dialogVisible.value = true;
          };

          const handleDelete = async (row) => {
            try {
              const res = await authenticatedFetch(`/api/apps/${row.id}`, {
                method: "DELETE",
              });
              const data = await res.json();
              if (data.code === 0) {
                ElMessage.success("删除成功");
                fetchApps();
              } else {
                ElMessage.error(data.message);
              }
            } catch (e) {
              ElMessage.error("删除失败");
            }
          };

          const submitForm = async () => {
            if (!formRef.value) return;
            await formRef.value.validate(async (valid) => {
              if (valid) {
                submitting.value = true;
                try {
                  const url = isEdit.value
                    ? `/api/apps/${form.id}`
                    : "/api/apps";
                  const method = isEdit.value ? "PUT" : "POST";

                  const res = await authenticatedFetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(form),
                  });
                  const data = await res.json();
                  if (data.code === 0) {
                    ElMessage.success(isEdit.value ? "修改成功" : "添加成功");
                    dialogVisible.value = false;
                    fetchApps();
                  } else {
                    ElMessage.error(data.message);
                  }
                } catch (e) {
                  ElMessage.error("提交失败");
                } finally {
                  submitting.value = false;
                }
              }
            });
          };

          // 解析 APK 文件
          const parseApkFile = async (file) => {
            try {
              const parser = new AppInfoParser(file);
              const result = await parser.parse();
              console.log('APK Parse Result:', result);
              
              // 填充表单
              if (result.package) form.packageName = result.package;
              if (result.versionName) form.version = result.versionName;
              if (result.versionCode) form.versionCode = parseInt(result.versionCode);
              if (result.application?.label?.[0]) form.name = result.application.label[0];
              
              // 提取图标 (base64)
              if (result.icon) {
                // result.icon 是 base64 格式的图片
                form.iconUrl = result.icon;
              }
              
              apkParseInfo.value = {
                packageName: result.package,
                versionName: result.versionName,
                versionCode: result.versionCode
              };
              
              ElMessage.success('APK 解析成功，已自动填充信息');
              return true;
            } catch (e) {
              console.error('APK Parse Error:', e);
              ElMessage.warning('APK 解析失败，请手动填写信息');
              return true; // 继续上传
            }
          };
          
          const handleBeforeUpload = async (file) => {
            parsingApk.value = true;
            apkParseInfo.value = null;
            try {
              await parseApkFile(file);
            } finally {
              parsingApk.value = false;
            }
            return true; // 继续上传
          };

          const handleUploadSuccess = (response) => {
            if (response.code === 0) {
              form.downloadUrl = response.data.url;
              form.size = response.data.size;
              ElMessage.success("上传成功");
            } else {
              ElMessage.error(response.message);
            }
          };

          const handleUploadError = (error, uploadFile, uploadFiles) => {
            console.error("Upload error:", error);
            if (error.status === 401) {
              ElMessage.error("登录已过期，请重新登录");
              handleLogout();
            } else {
              ElMessage.error("上传失败: " + (error.message || "未知错误"));
            }
          };

          const formatSize = (bytes) => {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (
              parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
            );
          };

          const handleIconSuccess = (response) => {
             if (response.code === 0) {
              form.iconUrl = response.data.url;
              ElMessage.success("图标上传成功");
            } else {
              ElMessage.error(response.message);
            }
          };

           const handleIconError = (error) => {
            console.error("Icon upload error:", error);
            if (error.status === 401) {
              ElMessage.error("登录已过期，请重新登录");
              handleLogout();
            } else {
              ElMessage.error("图标上传失败: " + (error.message || "未知错误"));
            }
          };

          const getCategoryType = (cat) => {
            const map = {
              nav: "primary",
              media: "success",
              tools: "warning",
              other: "info",
            };
            return map[cat] || "info";
          };

          const getCategoryLabel = (cat) => {
            const map = {
              nav: "导航",
              media: "影音",
              tools: "工具",
              other: "其他",
            };
            return map[cat] || "其他";
          };

          onMounted(() => {
            fetchApps();
          });

          return {
            loading,
            tableData,
            dialogVisible,
            isEdit,
            form,
            rules,
            formRef,
            submitting,
            handleAdd,
            handleEdit,
            handleDelete,
            submitForm,
            handleBeforeUpload,
            handleUploadSuccess,
            handleUploadError,
            formatSize,
            handleIconSuccess,
            parsingApk,
            apkParseInfo,
            handleIconError,
            getCategoryType,
            getCategoryLabel,
            isLoggedIn,
            loginVisible,
            loginForm,
            loggingIn,
            handleLogin,
            handleLogout,
            authHeaders,
            getAuthHeaders
          };
        },
      });

      for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);
      }

      app.use(ElementPlus);
      app.mount("#app");
    </script>
  </body>
</html>
